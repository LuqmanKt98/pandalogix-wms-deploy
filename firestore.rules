rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }

    function userExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function getUserRole() {
      // Check if user exists and has a role field
      return userExists() && 'role' in getUserData() ? getUserData().role : null;
    }

    function isSuperAdmin() {
      return isAuthenticated() && getUserRole() == 'superAdmin';
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    function isStaff() {
      return isAuthenticated() && getUserRole() == 'staff';
    }

    function isAdminOrSuperAdmin() {
      return isSuperAdmin() || isAdmin();
    }

    function isAnyRole() {
      return isSuperAdmin() || isAdmin() || isStaff();
    }

    // Users collection rules
    match /users/{userId} {
      function getTargetUserRole() {
        return get(/databases/$(database)/documents/users/$(userId)).data.role;
      }
      
      // Allow reading own document or if admin/superAdmin
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdminOrSuperAdmin());

      // Create:
      // SuperAdmin can create any user.
      // Admin can create 'staff' users only.
      allow create: if isSuperAdmin() 
                    || (isAdmin() && request.resource.data.role == 'staff');

      // Update:
      // SuperAdmin can update users
      // Admin can update ONLY 'staff' users, and can only maintain their role as 'staff'.
      // Admin cannot update SuperAdmin or other Admins.
      allow update: if isSuperAdmin()
                    || (isAdmin() 
                        && getTargetUserRole() == 'staff' 
                        && request.resource.data.role == 'staff');

      // Delete:
      // SuperAdmin can delete users (except self, usually handled by client logic/auth rules).
      // Admin can delete ONLY 'staff' users.
      // Admin cannot delete SuperAdmin or other Admins.
      allow delete: if isSuperAdmin()
                    || (isAdmin() && getTargetUserRole() == 'staff');
    }

    // Clients collection - Role-based access control
    match /clients/{clientId} {
      allow read: if isAnyRole();
      
      // Staff cannot create, update, delete (Read Only)
      // Admin and SuperAdmin can create, update, delete
      allow create, update, delete: if isAdminOrSuperAdmin();
    }

    // Inventory collection - Role-based access control
    match /inventory/{inventoryId} {
      allow read: if isAnyRole();
      
      // Staff cannot create, update, delete
      allow create, update, delete: if isAdminOrSuperAdmin();
    }

    // Goods Received - Role-based access control
    match /goodsReceived/{receivedId} {
      allow read: if isAnyRole();
      
      // Staff cannot create, update, delete
      allow create, update, delete: if isAdminOrSuperAdmin();
    }

    // Shipments - Role-based access control
    match /shipments/{shipmentId} {
      allow read: if isAnyRole();
      
      // Staff cannot create, update, delete
      allow create, update, delete: if isAdminOrSuperAdmin();
    }

    // Activity Log - Admin and Super Admin can read, all authenticated users can write logs
    match /activityLog/{logId} {
      allow read: if isAdminOrSuperAdmin();
      allow create: if isAnyRole();
      allow update, delete: if false; // Logs are immutable
    }
  }
}

